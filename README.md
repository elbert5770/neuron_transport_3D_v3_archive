# neuron_transport_3D_v3_archive
Repository for files to analyze mass transport around neurons from image stack data. Julia 1.11.X plus the latest versions of all packages used should work.

1) Data is downloaded from Microns Explorer using ImageSegmentation_14.0.py.  Note the folder structure in use: start one folder with the program files and another folder called 'Neuron_transport_data' in the same directory.  The settings are stored in the file 'Simulation_settings_4.0_smoothed.csv. The simulation number is the first column and in the current program is set to '1'.  The base volume is specified in columns 2-5 and the number of adjacent volumes is specified in the next six columns.  The final column 'z_filled' is used to specify if zloc has been multiplied by 5 with 4 interpolated frames inserted.  At the start, z_filled is 0.  The python version requirements are listed in the file.
2) The downloaded data is mode filtered and interpolated.  This is in a separate repository.  Interpolation is necessary for the following steps, so follow the directions at the other repository to accomplish this.
3) After mode filtering and interpolation, run unique_neurons_4.1_smooth.jl.  This depends on the file 'Simulation_settings_4.0_smoothed.csv'. The sim_number is set in the program.  The program writes the file 'MarchingCubes_settings_smooth.csv' that is used by MarchingCubes*.c and Ply2JLD2*.jl.
4) Compile and run MarchingCubes3D_2.0a_smoothz_mpi.c.  This requires a functioning MPI implementation.  We used Intel's oneAPI/2023.2.1 or Intel(R) MPI Library 2018 Update 3 for Windows but other implementations of MPI should work.  Compile and run the program from the base folder as:
mpicc -g -o MarchingCubes3D_2.0a_smoothz_mpi MarchingCubes3D_2.0a_smoothz_mpi.c -lm
mpiexec -n 40 ./MarchingCubes3D_2.0a_smoothz_mpi 1
The argument to the program '1' refers to a row in 'MarchingCubes_settings_smooth.csv'. This is a single analysis volume.  All analysis volumes may be run together using run_mc.sh.
5) The ply files generated by the marching cubes program are reprocessed by PlyToJLD2_3D_3.0a.jl. This program also uses the 'MarchingCubes_settings_smooth.csv' and can be automated with run_ply.sh.
6) The extracted files are then set up for solving by neuron_transport_setup_3D_3.0a.jl.  This requires the .toml file and the sim_number is passed as an argument.  The sim_number is used to read from 'Simulation_settings_4.0_smoothed.csv', which for the array of 8 analysis volumes would be 4.
7) The equations are solved with neuron_transport_solve_3D_3.0a.jl.  The sim_number needs to be the same as in the setup program.  Also, within the program, restart = false to start from time = 0.  If a restart is needed, this is changed to restart = true.  The number of time steps is also set within the code.  If the simulation needs to be restarted at time = 0, re-run the setup program first.  The frequency of saving vtk files is also set from within the code.
